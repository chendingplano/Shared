# Issue #4: Add Kratos Support to UpdatePassword

**Date:** 2026-02-14
**Status:** Resolved
**Affected Module:** `shared/go`

## Problem

The `UpdatePassword` function in `EchoFactory` did not support Kratos-based authentication. When `AUTH_USE_KRATOS=true`, it rejected all password update requests with an error message, directing callers to use the recovery flow (`HandleResetPasswordConfirmKratos`) instead.

This prevented programmatic password updates (e.g., admin-initiated resets, settings page changes) from working when Kratos was enabled.

## Root Cause

The original implementation only supported direct database updates via `sysdatastores.UpdatePasswordByEmail`. There was no Kratos Admin API integration for password updates, unlike other functions such as `GetUserInfoByEmail` and `GetUserInfoByUserID` which already had dual-mode support.

## Solution

### Files Changed

| File | Change |
|------|--------|
| `api/EchoFactory/echo_factory.go` | Added `KratosUpdatePasswordFuncDef` type and `KratosUpdatePasswordFunc` variable; updated `UpdatePassword` to call Kratos function when enabled |
| `api/auth/kratos.go` | Implemented `KratosUpdatePassword` function; registered it in `InitKratosClient()` |

### 1. EchoFactory: Function Pointer and Dual-Mode UpdatePassword

Added a new function pointer type following the established pattern for breaking compile-time circular imports:

```go
type KratosUpdatePasswordFuncDef func(
    logger ApiTypes.JimoLogger,
    email string,
    plaintextPassword string,
) error

var KratosUpdatePasswordFunc KratosUpdatePasswordFuncDef
```

Updated `UpdatePassword` to check `AUTH_USE_KRATOS` and delegate accordingly:

- **Kratos enabled:** Calls `KratosUpdatePasswordFunc` which updates the password via Kratos Admin API
- **Kratos disabled:** Uses the original implementation (bcrypt hash + `sysdatastores.UpdatePasswordByEmail`)

### 2. Kratos: KratosUpdatePassword Implementation

Implemented `KratosUpdatePassword` in `api/auth/kratos.go` using the GET-then-PUT pattern against the Kratos Admin API:

1. **Resolve identity** - Calls `KratosGetIdentityByEmail` to get the identity ID
2. **Fetch current identity** - `GET /admin/identities/{id}` to retrieve current traits, metadata, and state
3. **Update with new password** - `PUT /admin/identities/{id}` with the `credentials.password.config.password` field set, preserving all existing identity data (`schema_id`, `traits`, `state`, `metadata_public`, `metadata_admin`)

Error codes: `SHD_KAH_060` through `SHD_KAH_069`

### 3. Registration

Registered the function in `InitKratosClient()`:

```go
EchoFactory.KratosUpdatePasswordFunc = KratosUpdatePassword
```

## Design Decisions

- **Followed existing patterns:** The implementation mirrors `GetUserInfoByEmail` for the dual-mode check and `KratosMarkUserVerified` for the Kratos Admin API interaction style.
- **Preserves identity data:** The GET-then-PUT pattern ensures no existing traits, metadata, or state is lost during the password update.
- **Plaintext password forwarded to Kratos:** Kratos handles its own password hashing internally, so the plaintext password is sent via the Admin API (over localhost/internal network). Bcrypt hashing is only done in the non-Kratos path.

## Testing

- `go build ./...` passes with no errors.
- Non-Kratos path remains unchanged (bcrypt hash + database update).
- Kratos path requires `KRATOS_ADMIN_URL` to be set and Kratos to be running.
